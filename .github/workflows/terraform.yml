name: terraform

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      action:
        description: "What to do"
        type: choice
        required: true
        default: plan
        options: [plan, apply]
      stack:
        description: "Which environment(s) to run"
        type: choice
        required: true
        default: both
        options: [dev, prod, both]
      force_apply:
        description: "Allow apply re-runs even if no new code changes exist"
        type: boolean
        required: true
        default: false

permissions:
  contents: read
  id-token: write

concurrency:
  group: tf-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ARM_USE_OIDC: true
  ARM_USE_AZUREAD: true
  ARM_OIDC_AUDIENCE: api://AzureADTokenExchange
  ARM_CLIENT_ID: ${{ vars.ARM_CLIENT_ID || '##########' }}
  ARM_TENANT_ID: ${{ vars.ARM_TENANT_ID || '##########' }}
  # Azure CLI context for login; Terraform uses subscription_id from the env tfvars.
  ARM_SUBSCRIPTION_ID: ${{ vars.ARM_SUBSCRIPTION_ID || '##########' }}
  TF_IN_AUTOMATION: true

jobs:
  plan:
    name: plan (${{ matrix.stack }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        stack: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.stack != 'both') && fromJSON(format('["{0}"]', github.event.inputs.stack)) || fromJSON('["dev","prod"]') }}

    steps:
      - uses: actions/checkout@v4

      - name: Guard (prevent GUID leaks)
        shell: bash
        run: bash scripts/check_no_guids.sh

      - name: Preflight (required repo variables)
        shell: bash
        run: |
          set -euo pipefail

          missing=0

          for v in ARM_CLIENT_ID ARM_TENANT_ID ARM_SUBSCRIPTION_ID; do
            val="${!v:-}"
            if [[ -z "${val}" || "${val}" == "##########" ]]; then
              echo "ERROR: ${v} is not set. Configure it as a GitHub Repo Variable (Settings → Secrets and variables → Actions → Variables)."
              missing=1
            fi
          done

          # Ensure backend.hcl placeholders were replaced.
          if grep -R --line-number --fixed-strings '"##########"' "environments/${{ matrix.stack }}/backend.hcl" >/dev/null; then
            echo "ERROR: environments/${{ matrix.stack }}/backend.hcl still contains placeholder values (##########)."
            echo "Update backend.hcl to point to your remote state storage."
            missing=1
          fi

          # Ensure terraform.tfvars placeholders were replaced.
          if grep -R --line-number --fixed-strings '"##########"' "environments/${{ matrix.stack }}/terraform.tfvars" >/dev/null; then
            echo "ERROR: environments/${{ matrix.stack }}/terraform.tfvars still contains placeholder values (##########)."
            echo "Update terraform.tfvars (or use TF_VAR_* overrides in GitHub Actions) before running plan/apply."
            missing=1
          fi

          if [[ "${missing}" -ne 0 ]]; then
            exit 1
          fi

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}
          audience: ${{ env.ARM_OIDC_AUDIENCE }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform fmt check
        run: terraform fmt -check -recursive

      - name: Terraform init
        run: terraform init -input=false -backend-config=environments/${{ matrix.stack }}/backend.hcl

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan
        run: terraform plan -input=false -no-color -var-file=environments/${{ matrix.stack }}/terraform.tfvars -out=tfplan

      - name: Terraform plan summary
        if: always()
        shell: bash
        run: |
          if [[ -f tfplan ]]; then
            summary="$(terraform show -no-color tfplan | awk '
              /^No changes\./{line=$0}
              /^Plan: /{line=$0}
              END{print line}
            ')"

            if [[ -z "${summary}" ]]; then
              summary="Plan summary not found (see artifact)."
            fi

            echo "${summary}"
            {
              echo "### Terraform plan summary (${{ matrix.stack }})"
              echo ""
              echo "\`${summary}\`"
            } >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "Plan output not available."
            {
              echo "### Terraform plan summary (${{ matrix.stack }})"
              echo ""
              echo "Plan output not available."
            } >> "${GITHUB_STEP_SUMMARY}"
          fi

      - name: Save plan output
        if: always()
        shell: bash
        run: |
          if [[ -f tfplan ]]; then
            terraform show -no-color tfplan > plan-${{ matrix.stack }}.txt
          else
            echo "Plan output not available." > plan-${{ matrix.stack }}.txt
          fi

      - name: Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.stack }}
          path: plan-${{ matrix.stack }}.txt
          if-no-files-found: warn

  apply:
    name: apply
    runs-on: ubuntu-latest
    needs: plan
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply' && github.event.inputs.force_apply == 'true')
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.ARM_CLIENT_ID }}
          tenant-id: ${{ env.ARM_TENANT_ID }}
          subscription-id: ${{ env.ARM_SUBSCRIPTION_ID }}
          audience: ${{ env.ARM_OIDC_AUDIENCE }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform apply (selected environments)
        shell: bash
        run: |
          set -euo pipefail

          stacks="dev prod"
          if [[ "${{ github.event_name }}" == 'workflow_dispatch' ]]; then
            case "${{ github.event.inputs.stack }}" in
              dev) stacks="dev" ;;
              prod) stacks="prod" ;;
              both|*) stacks="dev prod" ;;
            esac
          fi

          for stack in ${stacks}; do
            echo "=== Applying ${stack} ==="
            rm -rf .terraform
            terraform init -input=false -reconfigure -backend-config="environments/${stack}/backend.hcl"
            terraform apply -lock-timeout=10m -input=false -auto-approve -var-file="environments/${stack}/terraform.tfvars"
          done
